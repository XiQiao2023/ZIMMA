---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# Decoding Microbiome Dual Mediation: Introducing ZIMMA for Enhanced Zero-Inflated Data Analysis

<!-- badges: start -->
<!-- badges: end -->

Given the complex interactions between the microbiome, the host, and external factors, causal mediation analysis is essential for unraveling how dysbiosis or microbial imbalance mediates the effects of interventions or environmental exposures on health outcomes. However, zero inflation in microbiome count data complicates high-dimensional mediation analysis, as frequently employed zero-inflated models often struggle to distinguish true zero inflation from the underlying count distribution. To address this, we employ a zero-inflated negative binomial distribution for each mediator within a Bayesian framework, incorporating spike-and-slab priors to enable sparsity in estimating natural indirect effects (NIE) and an informative prior based on nonzero counts to improve dispersion estimation and control zero sources. Recognizing the distinct biological mechanisms underlying microbial presence versus abundance, we developed a dual mediation model, ZIMMA, to separate the NIE into pathways for mediator abundance and prevalence. Extensive simulations demonstrate ZIMMA's superior performance in capturing distinct mediation mechanisms for both rare and abundant species compared to existing methods. Its application to human microbiome studies examining the effects of dietary intake and metabolic syndrome underscores its efficacy in identifying key microbial mediators, offering valuable insights and biological interpretation into the role of the microbiome in disease physiology and health sciences.

## Installation

You can install the development version of ZIMMA like so:

``` r
devtools::install_github("XiQiao2023/ZIMMA")
```

## Load the Phyloseq Object

```{r example}
library(ZIMMA)

data("Hema_physeq")
Hema_physeq

## Data filtering
M <- as.data.frame(t(Hema_physeq@otu_table))
M <- M[, colMeans(M != 0) > 0.01] # Prevalence > 1%

# Count the number of unique features at each taxonomic level
taxa_to_keep <- colnames(M)
physeq_filtered <- prune_taxa(taxa_to_keep, Hema_physeq)
taxa_table_filtered <- tax_table(physeq_filtered)
apply(taxa_table_filtered, 2, function(x) length(unique(x[!is.na(x)])))
```

## Apply the dual mediation framework

```{r, eval = FALSE}
Hema_Phylum_Result = ZIMMA(object = physeq_filtered, 
               Outcome = "log_BC", 
               Treat = "Drug_piperacillinOrtazobactam_Prior_Use", 
               C.med = c("HCTSource","Disease",
                         "Drug_ciprofloxacin_Prior_Use",
                         "Drug_ganciclovir_Prior_Use"), 
               C.out =  c("HCTSource","Disease",
                          "Drug_ciprofloxacin_Prior_Use",
                          "Drug_ganciclovir_Prior_Use",
                          "Drug_imipenem_cilastatin_Post_Use",
                          "Drug_piperacillinOrtazobactam_Post_Use",
                          "Drug_atovaquone_Post_Use",
                          "Drug_isavuconazonium_sulfate_Post_Use",
                          "Drug_meropenem_Post_Use"), 
               M.level = "Phylum",
               n_iter = 20000, burn_in = 5000,
               Size = "RLEpseudo", pseudo = 0.5)

save(Hema_Phylum_Result,file = "Hema_Phylum_Result.rda")
```

## Check the results
```{r,echo = FALSE}
data("Hema_Phylum_Result")
```

```{r}
sum = ZIMMA.summary(Hema_Phylum_Result)

NIE.A = which(sum$betaT[,1]>0.5 & sum$alphaM[,1]>0.5) 
sum$betaT[NIE.A,, drop = FALSE]
sum$alphaM[NIE.A,,drop = FALSE]

NIE.P = which(sum$gammaT[,1]>0.5 & sum$alphaM[,1]>0.5)
sum$gammaT[NIE.P,,drop = FALSE]
sum$alphaM[NIE.P,,drop = FALSE]
```

